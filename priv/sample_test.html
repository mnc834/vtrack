<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>sample test</title>
    <script type="text/javascript" src="/js/v_plane.js"></script>
    <script type="text/javascript" src="/js/g_objects.js"></script>
</head>
<body>

<canvas id="Canvas" width="500" height="250" style="border:1px solid #d3d3d3;">
    Your browser does not support the HTML5 canvas tag.</canvas>

<script>
    var canvas = document.getElementById("Canvas");
    v_plane = new V_plane(canvas);

    var xmlhttp = new XMLHttpRequest();
    var url = "sample";

    xmlhttp.onreadystatechange = function()
    {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200)
        {
            var response = JSON.parse(xmlhttp.responseText);
            process_response(response);
        }
    };

    xmlhttp.open("GET", url, true);
    xmlhttp.send();

    function process_response(response)
    {
        var n = response.length;
        var v = new Array(n);
        var i;
        var t0 = response[0].time;
        var p0 = response[0].price;
        for (i = 0; i < response.length; i++)
        {
            v[i] = {x: response[i].time - t0, y: response[i].price - p0};
        }
        v_plane.add_g_object(new G_sample_list(v, "#FF0000"));

        set_scale_processor(v_plane, v);
    }

    function set_scale_processor(v_plane, v)
    {
        var max = v[0].y;
        var min = max;
        var i;
        for (i = 0; i < v.length; i++)
        {
            var p = v[i].y;
            if (min > p)
            {
                min = p
            }
            if (max < p)
            {
                max = p
            }
        }

        var delta = max - min;
        console.log("min: " + min + "; max: " + max);

        v_plane.set_scale_processor(function(cur_scale, d_scale)
        {
            var w = v_plane.get_physical_window();
            var dy = w.top - w.bottom;
            var ratio = 1 + d_scale;
            console.log("Delta: " + delta + "; dy: " + dy + "; d_scale:" + d_scale);
            if ((dy < (delta * 3)) && (d_scale < 0))
            {
                cur_scale.y *= ratio;
            }
            else
            {
                if ((dy > (delta / 3)) && (d_scale > 0))
                {
                    cur_scale.y *= ratio;
                }
            }
            cur_scale.x *= ratio;

            return cur_scale
        })
    }

</script>

</body>
</html>